# 2025-12-31 작업일지

## 오늘 완료한 작업

### 1. TipTap 리치 텍스트 에디터 구현
- **목적**: 슬라이드별 요약과 사용자 노트를 작성할 수 있는 리치 텍스트 에디터 구현
- **구현 내용**:
  - TipTap 패키지 설치 (@tiptap/react, @tiptap/starter-kit, @tiptap/extension-underline, @tiptap/extension-color, @tiptap/extension-highlight)
  - TipTapEditor 컴포넌트 생성
  - 슬라이드별 요약과 사용자 노트 각각에 TipTap 에디터 적용
  - 자동 저장 기능 구현 (1초 디바운스)
- **결과**: 사용자가 슬라이드별로 요약을 작성하고 포맷팅(굵게, 기울임, 밑줄, 색상, 하이라이트 등)할 수 있는 기능 완성

### 2. slide_summaries 테이블 생성
- **목적**: 슬라이드별 요약 데이터를 DB에 저장
- **구현 내용**:
  - Supabase에 slide_summaries 테이블 마이그레이션 적용
  - TipTap JSON 형식으로 summary_content, user_notes_content 저장
  - RLS 정책 설정 (사용자는 자신의 문서 요약만 조회/수정 가능)
  - GIN 인덱스 추가 (JSONB 검색용)
- **결과**: 슬라이드별 요약 데이터가 DB에 정상적으로 저장됨

### 3. 파일 불러오기 로직 구현
- **목적**: 업로드된 파일을 문서 상세 페이지에서 표시
- **구현 내용**:
  - fetchFileById 함수 추가 (파일 ID로 직접 조회)
  - getFileUrl 함수 에러 처리 개선
  - 문서 상세 페이지에서 실제 DB 데이터 연결
  - 빈 요약 데이터로 시작하도록 수정
- **결과**: 파일 업로드 후 문서 상세 페이지에서 파일 정보 표시 가능

### 4. PDF 뷰어 구현 시도
- **목적**: 업로드된 PDF 파일을 실제로 표시
- **구현 내용**:
  - react-pdf 라이브러리 사용
  - PDFViewer 컴포넌트 수정 (임시 텍스트 표시 → 실제 PDF 표시)
  - PDF.js worker 설정 추가
- **결과**: 부분적으로 구현되었으나 최종적으로 작동하지 않음

## 발생한 문제들

### 1. TipTap Import 에러
- **문제**: `@tiptap/extension-text-style` does not contain a default export
- **원인**: TextStyle은 StarterKit에 포함되어 있어 별도 import 불필요
- **해결**: TextStyle import 제거

### 2. TipTap Underline 중복 경고
- **문제**: `[tiptap warn]: Duplicate extension names found: ['underline']`
- **원인**: StarterKit에 underline이 포함되어 있을 가능성
- **해결**: StarterKit에서 underline을 명시적으로 비활성화하고 별도 Underline extension 사용

### 3. PDF.js Worker 404 에러
- **문제**: `GET https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.8.69/pdf.worker.min.js net::ERR_ABORTED 404`
- **원인**: CDN 경로가 잘못되었거나 버전 불일치
- **시도한 해결책**:
  - unpkg CDN으로 변경
  - worker 파일을 public 폴더에 복사 시도 (실패)
  - useEffect에서 worker 설정하도록 변경

### 4. Object.defineProperty 에러
- **문제**: `Object.defineProperty called on non-object`
- **원인**: PDF.js worker가 제대로 초기화되지 않음 또는 Next.js SSR과의 충돌
- **시도한 해결책**:
  - worker 설정을 useEffect로 이동
  - options 제거
  - worker 경로를 unpkg로 변경
- **결과**: 해결되지 않음

### 5. PDF 무한 로딩
- **문제**: PDF 파일이 로드되지 않고 계속 로딩 상태
- **원인**: PDF.js worker 초기화 실패로 인한 것으로 추정
- **시도한 해결책**:
  - 로딩 상태 관리 개선
  - 에러 처리 추가
  - pdfUrl이 null일 때 처리 추가
- **결과**: 근본 원인 해결되지 않음

## 현재 막힌 문제

### PDF 뷰어 작동 불가
- **상태**: PDF 파일이 표시되지 않음
- **에러**: 
  - `Object.defineProperty called on non-object`
  - PDF.js worker 로드 실패
- **원인 추정**:
  1. react-pdf와 pdfjs-dist 버전 호환성 문제
  2. Next.js SSR 환경에서 PDF.js worker 초기화 문제
  3. CDN에서 worker 파일 로드 실패
- **시도했지만 실패한 방법**:
  - 다양한 CDN 경로 시도 (cdnjs, unpkg)
  - worker 파일을 public 폴더에 복사
  - useEffect에서 worker 설정
  - options 제거
- **다음에 시도할 방법**:
  1. react-pdf 버전 확인 및 업데이트
  2. dynamic import 사용하여 PDFViewer 컴포넌트 클라이언트 사이드에서만 로드
  3. worker 파일을 public 폴더에 직접 배치하고 경로 지정
  4. 다른 PDF 뷰어 라이브러리 검토 (예: pdf.js 직접 사용, react-pdf-renderer 등)

## 다음 작업 계획

1. **PDF 뷰어 문제 해결** (최우선)
   - dynamic import로 PDFViewer 컴포넌트 클라이언트 사이드 전용으로 변경
   - worker 파일을 public 폴더에 직접 배치
   - react-pdf 버전 확인 및 호환성 검토

2. **파일 업로드 후 페이지 수 자동 감지**
   - PDF 업로드 시 page_count 자동 계산 및 DB 저장
   - 문서 상세 페이지에서 실제 페이지 수 사용

3. **요약 기능 테스트**
   - TipTap 에디터로 작성한 내용이 DB에 정상 저장되는지 확인
   - 저장된 내용이 다시 불러와질 때 정상 표시되는지 확인

4. **에러 처리 개선**
   - PDF 로드 실패 시 사용자에게 명확한 메시지 표시
   - 네트워크 에러 처리

## 참고사항

- TipTap 에디터는 정상 작동함
- slide_summaries 테이블은 정상 생성됨
- 파일 업로드 및 메타데이터 저장은 정상 작동함
- PDF 뷰어만 현재 작동하지 않음

---

## 추가 작업 (문서 휴지통 기능)

### 문서 소프트 삭제 기능 구현
- **목적**: 문서 삭제 시 휴지통에 저장하여 복구 가능하도록 개선
- **구현 내용**:
  1. **데이터베이스 마이그레이션**
     - `files` 테이블에 `deleted_at` 컬럼 추가
     - 삭제되지 않은 파일 조회 최적화를 위한 인덱스 추가
     - 마이그레이션 파일: `migrations/add_deleted_at_to_files.sql`
  
  2. **lib/files.ts 수정**
     - `deleteFile`: 하드 삭제 → 소프트 삭제로 변경 (Storage 파일은 유지)
     - `restoreFile`: 삭제된 파일 복구 함수 추가
     - `permanentlyDeleteFile`: 영구 삭제 함수 추가 (Storage + DB 완전 삭제)
     - `fetchFiles`: `deleted_at IS NULL` 조건 추가
     - `fetchDeletedFiles`: 삭제된 파일 목록 조회 함수 추가
  
  3. **lib/folders.ts 수정**
     - `deleteFolderInDB`: 폴더 삭제 시 내부 파일들도 소프트 삭제 처리
     - `deleteFileInDB`: 하드 삭제 → 소프트 삭제로 변경
     - `fetchFiles`: `deleted_at IS NULL` 조건 추가
     - `fetchDeletedFiles`: 삭제된 파일 목록 조회 함수 추가
     - `restoreFileInDB`: 파일 복구 함수 추가
     - `permanentlyDeleteFileInDB`: 파일 영구 삭제 함수 추가
     - `fetchDeletedFolders`: 삭제된 파일도 포함하도록 수정
  
  4. **FolderContext 수정**
     - `restoreFile`: 파일 복구 함수 추가
     - `permanentlyDeleteFile`: 파일 영구 삭제 함수 추가
     - Context에 함수 export 추가
  
  5. **휴지통 페이지 수정**
     - 문서도 표시하도록 수정
     - 문서 복구/영구삭제 버튼 추가
     - 일괄 복구/영구삭제 시 문서도 처리하도록 수정
  
- **결과**: 
  - 문서 삭제 시 휴지통에 저장됨
  - 휴지통에서 문서 복구 가능
  - 폴더 삭제 시 내부 문서도 함께 휴지통으로 이동
  - 영구 삭제 시 Storage 파일과 DB 데이터 모두 삭제 (CASCADE로 관련 데이터도 함께 삭제)

- **주의사항**:
  - 마이그레이션 실행 필요: `migrations/add_deleted_at_to_files.sql` 파일을 Supabase에서 실행
  - CASCADE 삭제: `files` 테이블을 실제 DELETE하면 관련된 `slide_summaries`, `document_full_summaries` 등이 자동 삭제됨
  - 소프트 삭제 시에는 CASCADE가 발생하지 않아 관련 데이터가 유지되어 복구 시 함께 복구됨

